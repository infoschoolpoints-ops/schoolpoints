# תכנית עבודה: היברידי / ענן מלא (SchoolPoints)

## עקרונות
- **Offline-first**: עמדות לא מקוונות ממשיכות לעבוד כרגיל, ללא תלות בענן.
- **שלושה מסלולים אפשריים לכל מוסד**:
  1) מקומי בלבד (שרת מקומי קטן)
  2) היברידי (מקומי + ענן)
  3) ענן מלא בלבד (ללא שרת מקומי)
- **ענן כולל הרשאות מלאות** לכל תפקידים וניהול מוסדות.

## מסלול 1 — מקומי בלבד (ללא ענן)
- DB מקומי/שיתופי כמו היום.
- אין שינוי בעמדות הפעילות.
- ממשיך לעבוד גם ללא אינטרנט.

## מסלול 2 — היברידי (שרת מקומי + ענן)
- עמדת “שרת מקומי” אחת במוסד.
- כל העמדות מסתנכרנות אליה כמו היום.
- השרת המקומי מעלה תור שינויים לענן ומוריד עדכונים חזרה.

## מסלול 3 — ענן מלא בלבד
- כל העמדות עובדות מול הענן.
- אין צורך בשרת מקומי.
- מתאים למוסדות עם אינטרנט יציב.

---

# שלב A (מינימלי, ללא שינוי בעמדות פעילות)
מטרה: בניית תשתית סנכרון בסיסית מבלי לגעת בעמדות הפעילות.

## A1. לוג שינויים מקומי (Change Log)
- הוספת טבלת `change_log` במסד המקומי.
- כל פעולה משמעותית (תיקופים/רכישות/עדכון תלמיד/הגדרות) נרשמת ללוג.
- הלוג נשאר מקומי בלבד בשלב זה.

## A2. Sync Agent מקומי
- שירות קטן שרץ על השרת המקומי.
- קורא את ה־`change_log` ושולח אותו לענן לפי תור.
- אין שינוי בעמדות אחרות.

### קובץ שירות
- הקובץ נוצר: `sync_agent.py`
- אינו מופעל אוטומטית — ניתן להרצה ידנית בעתיד בלבד.

### הגדרות בקובץ config.json
- `sync_push_url` — כתובת ה־API בענן לקבלת שינויי DB.
- ניתן להשאיר ריק כדי לא לבצע סנכרון.

## A3. מבנה API בסיסי בענן
- נקודת קצה `POST /sync/push` לקבלת אירועים.
- מזהה מוסד (`tenant_id`) + מפתח גישה (`api_key`) בכל בקשה.
- שמירה בטבלאות ענן לפי מוסד.

### פורמט מומלץ ל־payload
```json
{
  "tenant_id": "school_123",
  "station_id": "cashier-01",
  "changes": [
    {
      "id": 1001,
      "entity_type": "student_points",
      "entity_id": "42",
      "action_type": "update",
      "payload_json": "{...}",
      "created_at": "2026-01-25 01:00:00"
    }
  ]
}
```

### אימות בסיסי (שלב ראשון)
- מפתח API לכל מוסד.
- הגבלת קצב בסיסית + לוג שגיאות.

---

# שלב B (דו־כיווני)
- סנכרון גם מהענן חזרה לשרת המקומי.
- עדכונים כגון: תלמידים, הגדרות, קטלוגים.
- נקודת קצה `GET /sync/pull?since=<timestamp>`
- השרת המקומי שומר שדה `last_pull_at` ומוריד רק שינויים חדשים.

# שלב C (ענן מלא)
- לקוחות מתחברים ישירות לענן.
- הרשאות מלאות בענן.
- מצב זה מחליף את הצורך בשרת מקומי.
- ניתן לאפשר `offline cache` נקודתי לעמדה (אופציונלי).

---

# בדיקת ביצועים (ללא האטה לעמדות קיימות)
- לוודא שתיקוף/קנייה לא מתעכבים לאחר רישום change_log.
- מדידת זמן פעולה לפני/אחרי (במדגם קטן של פעולות).
- מעקב אחרי גודל DB כדי לוודא שהלוג לא מתנפח מהר מדי.

# צ'ק-ליסט Rollout (מהקטן לגדול)
1) פיילוט במוסד אחד קטן (עמדה ציבורית + שרת מקומי)
2) הוספת עמדות נוספות במוסד (לוודא יציבות סנכרון)
3) פתיחת API לענן לעדכון מרחוק (למוסדות שצריכים)
4) פתיחת מסלול ענן מלא למוסדות חדשים

# אבטחה בסיסית (שלב ראשון)
- `api_key` נפרד לכל מוסד
- הגבלת קצב בקשות (Rate limit)
- לוג שגיאות מרכזי בענן
- אפשרות ביטול מפתח במקרה חריג

# דוגמת config.json (בשרת המקומי)
```json
{
  "sync_push_url": "https://your-cloud-domain.com/sync/push",
  "sync_api_key": "API_KEY_FOR_TENANT",
  "sync_tenant_id": "school_123",
  "sync_station_id": "server-01"
}
```

# Deploy (DigitalOcean) – פרטים קבועים

## Repo
- **GitHub**: https://github.com/infoschoolpoints-ops/schoolpoints
- **Branch**: `master`

## App domains
- **Starter domain**: https://dolphin-app-wyhxb.ondigitalocean.app
- **Custom**: https://schoolpoints.co.il
- **Custom**: https://www.schoolpoints.co.il

## Run command (Web Service)
```bash
python -m uvicorn cloud_service.app:app --host 0.0.0.0 --port $PORT
```

## בדיקות אחרי Deploy
- `GET /__version`
- `GET /health`
- `GET /` (אמור להפנות ל־`/web/login`)

דוגמאות:
- https://dolphin-app-wyhxb.ondigitalocean.app/__version
- https://dolphin-app-wyhxb.ondigitalocean.app/health
- https://schoolpoints.co.il/__version
- https://schoolpoints.co.il/health

# הרצה ידנית של Sync Agent (שרת מקומי בלבד)
```
python sync_agent.py
```

# טבלאות מומלצות לסנכרון
- students
- transactions / validations
- purchases
- rewards / bonuses
- settings
- products

---

# הרשאות בענן (דוגמה)
- מנהל מערכת (Super Admin)
- מנהל מוסד
- מנהל תחנה / מפעיל
- מורה
- צפייה בלבד

---

# הערות ביצוע
- אין שינוי בעמדות פעילות בשלב A.
- כל המעבר לענן הוא אופציונלי ומדורג.
